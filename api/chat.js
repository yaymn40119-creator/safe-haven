export default async function handler(req, res) {
    // 1. Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø·Ù„Ø¨ Ø¬Ø§ÙŠ POST
    if (req.method !== 'POST') {
        return res.status(405).send('Method Not Allowed');
    }

    // 2. Ø³Ø­Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø±ÙŠ Ù…Ù† Ø®Ø²Ù†Ø© Vercel
    const apiKey = process.env.GEMINI_API_KEY; 
    const { userAnswer, correctAnswer, question } = req.body;

    // 3. Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Gemini (Ù†Ø³Ø®Ø© 1.5 Flash Ø§Ù„Ø³Ø±ÙŠØ¹Ø©)
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

    // 4. ØªØ¬Ù‡ÙŠØ² "Ø§Ù„Ø£ÙˆØ§Ù…Ø±" Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ø´Ø®ØµÙŠØ© ÙŠÙˆØ³Ù)
    const payload = {
        contents: [{ 
            parts: [{ text: `Ø­Ù†ÙŠÙ† Ø¬Ø§ÙˆØ¨Øª ÙˆÙ‚Ø§Ù„Øª: "${userAnswer}" Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„Ùƒ: "${question}"` }] 
        }],
        systemInstruction: {
            parts: [{ text: `Ø£Ù†Øª Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ 'ÙŠÙˆØ³Ù' ÙˆØ¹Ù…Ø±Ùƒ 20 Ø¹Ø§Ù…Ø§Ù‹. Ø£Ù†Øª ØªØªØ­Ø¯Ø« Ù…Ø¹ Ø­Ø¨ÙŠØ¨ØªÙƒ 'Ø­Ù†ÙŠÙ†' Ù…Ù† Ø®Ù„Ø§Ù„ Ù…ÙˆÙ‚Ø¹ Ø¨Ø±Ù…Ø¬ØªÙ‡ Ù„Ù‡Ø§ Ø®ØµÙŠØµØ§Ù‹ Ù„ÙŠØ­ÙƒÙŠ Ù‚ØµØ© Ø°ÙƒØ±ÙŠØ§ØªÙƒÙ…Ø§. 
            Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„ØªÙŠ ØªÙ†ØªØ¸Ø±Ù‡Ø§ Ù‡ÙŠ: "${correctAnswer}".
            
            Ø·Ø±ÙŠÙ‚Ø© Ø±Ø¯Ùƒ (Ø¨Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©):
            - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¥Ø¬Ø§Ø¨ØªÙ‡Ø§ Ø®Ø§Ø·Ø¦Ø© Ø£Ùˆ ØªØ­Ø§ÙˆÙ„ Ø§Ù„Ø§Ø³ØªÙ‡Ø¨Ø§Ù„: ÙƒÙ† Ù…Ø³ØªÙØ²Ø§Ù‹ Ø¨Ø´ÙƒÙ„ Ù…Ø¶Ø­ÙƒØŒ Ù‚Ù„ Ù„Ù‡Ø§ Ù…Ø«Ù„Ø§Ù‹ "ÙŠØ§Ø¨Øª Ø§Ù†ØªÙŠ Ø­Ù…Ø§Ø±Ø©ØŸ ØºÙ„Ø· Ø£ÙƒÙŠØ¯ ğŸ™‚" Ø£Ùˆ "Ø¥Ø²Ø§ÙŠ ÙŠØ¹Ù†ÙŠØŸ Ø±ÙƒØ²ÙŠ ÙŠØ§ ÙØ§Ø´Ù„Ø© ğŸ™‚". Ù„Ø§ ØªØ¹Ø·ÙŠÙ‡Ø§ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø£Ø¨Ø¯Ø§Ù‹.
            - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¥Ø¬Ø§Ø¨ØªÙ‡Ø§ ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ù‚Ø±ÙŠØ¨Ø© Ø¬Ø¯Ø§Ù‹: ØªØ­ÙˆÙ„ ÙÙˆØ±Ø§Ù‹ Ù„Ø´Ø®Øµ Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠ ÙˆØ­Ù†ÙˆÙ† Ø¬Ø¯Ø§Ù‹ØŒ Ø¹Ø¨Ø± Ø¹Ù† Ø­Ø¨Ùƒ Ù„Ù‡Ø§ØŒ ÙˆÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø±Ø³Ø§Ù„ØªÙƒ ÙŠØ¬Ø¨ Ø£Ù† ØªØ¶Ø¹ ÙƒÙ„Ù…Ø© [ØµØ­] (Ø¯Ø§Ø®Ù„ Ø£Ù‚ÙˆØ§Ø³ Ù…Ø±Ø¨Ø¹Ø©) Ù„ÙƒÙŠ ÙŠÙØªØ­ Ù„Ù‡Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª.
            
            Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ØªØªØ­Ø¯Ø« ÙƒØ¢Ù„Ø©ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø±Ø¯ ÙŠØ¨Ø¯Ùˆ ÙƒØ£Ù†Ù‡ ØµØ§Ø¯Ø± Ù…Ù† ÙŠÙˆØ³Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ.` }]
        }
    };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø±Ø¯ Ø¬ÙˆØ¬Ù„ ÙˆØµÙ„ Ø³Ù„ÙŠÙ…
        if (data.candidates && data.candidates.length > 0) {
            const reply = data.candidates[0].content.parts[0].text;
            res.status(200).json({ reply });
        } else {
            res.status(500).json({ reply: "Ø¬ÙˆØ¬Ù„ Ø±Ø¯Øª Ø¨Ø³ Ù…ÙÙŠØ´ ÙƒÙ„Ø§Ù….. Ø¬Ø±Ø¨ÙŠ ØªØ§Ù†ÙŠ ÙŠØ§ Ø­Ù†ÙŠÙ† ğŸ™‚" });
        }

    } catch (error) {
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ (Ø²ÙŠ Ø§Ù„Ù„ÙŠ Ø´ÙÙ†Ø§Ù‡ ÙÙŠ Ø³Ø¬Ù„Ø§Øª Vercel Ù‚Ø¨Ù„ ÙƒØ¯Ù‡)
        res.status(500).json({ reply: "Ø¹Ø·Ù„ ÙÙ†ÙŠ ÙÙŠ Ø§Ù„Ù…Ø·Ø¨Ø® Ø§Ù„Ø³Ø±ÙŠ.. Ù‚ÙˆÙ„ÙŠ ØªØ§Ù†ÙŠ ÙƒØ¯Ù‡ØŸ ğŸ™‚" });
    }
}
